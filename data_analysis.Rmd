---
title: "Art Data Analysis"
author: "Jens Laufer"
date: "17 2 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F)
```
```{r}
library(tidyverse)
library(glue)
library(mongolite)
library(jsonlite)
library(ggthemes)
library(bbplot)
library(scales)
library(ggrepel)
library(ggcorrplot)
```

```{r}
con <- mongo("pieces", url="mongodb://localhost/pieces")
```



```{r}
data <- con$find("{}") %>%
  jsonlite::flatten() %>%
  as_tibble() %>%
  filter(year !=  0) %>%
  separate(size, c("width", "height"), sep = " X ") %>%
  mutate(
    width = as.numeric(width)*2.54,
    height = as.numeric(height)*2.54,
    width_unit = "cm",
    height_unit = "cm",
    run = as.numeric(run),
    area = width * height,
    collections = as.numeric(collections),
    sold = as.numeric(sold)
  ) %>% 
  mutate(released=as.Date(as.POSIXct(as.numeric(released), origin="1970-01-01"))) %>% 
  separate(artist, c("artist_surname", "artist_firstname"), sep=", ") %>% 
  mutate(artist_firstname=replace_na(artist_firstname,"")) %>%
  unite(artist, artist_firstname, artist_surname, sep=" ") %>% 
  mutate(artist=str_trim(artist))
```



```{r}
data %>% write_csv("art_pieces.csv")
```



```{r}
data %>% 
  glimpse()
```
## Missing Values


```{r}
data %>% 
  mutate(row=row_number()) %>% 
  gather(-row, key="feature", value = "value") %>% 
  mutate(isNa=is.na(value)) %>% 
  group_by(feature) %>% 
  mutate(total=n()) %>% 
  ungroup() %>% 
  select(-value) %>% 
  ggplot(aes(x=feature, y=row, fill=isNa))+
  geom_raster()+
  coord_flip()
```


## Univariate Analysis

### Continous Variables
```{r fig.height=10, fig.width=20}
data %>% 
  select(-year, -artist_id, -id) %>% 
  select_if(is.numeric) %>% 
  gather(key = "feature", value = "value") %>% 
  filter(!is.na(value)) %>% 
  ggplot(aes(x = value, y = 0)) +
  geom_boxplot() +
  scale_x_continuous(trans="log10", labels = comma) +
  facet_wrap(~feature,scales = "free")
```

## Categorical Variables

```{r fig.height=10, fig.width=20}
data %>%
  select_if(negate(is.numeric)) %>%
  select(-released,-artwork,-artist,-paper) %>%
  select(-contains("_unit")) %>%
  gather() %>%
  group_by(key, value) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  ggplot(aes(x = reorder(value, n), y = n)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(trans = "log10", labels = comma) +
  coord_flip() +
  facet_wrap( ~ key, scales = "free")
```





```{r fig.height=10, fig.width=20}
data %>% 
  mutate(year_bucket=cut(year, 25, dig.lab=4)) %>% 
  group_by(year_bucket) %>%
  summarise(num=n()) %>% 
  ggplot(aes(x = reorder(year_bucket,num), y=num)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = comma, trans = "log10") +
  coord_flip() 
```

```{r}
data %>% 
  group_by(artist) %>%
  summarise(num=n()) %>%
  mutate(label=if_else(num>500, artist, "")) %>% 
  ggplot(aes(x = "", y = num)) +
  geom_boxplot() +
  geom_label_repel(aes(label=label))+
  scale_y_continuous(trans="log10")+
  coord_flip()
```




## Bivariate Analysis

```{r}
data %>% 
  drop_na() %>% 
  select(-year, -artist_id, -id) %>% 
  select_if(is.numeric) %>% 
  cor() %>% 
  ggcorrplot(method = "circle")
```

